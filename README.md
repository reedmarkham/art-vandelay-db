## 🎨 art-vandelay-db

This project is an AWS CDK application designed to deploy an Amazon OpenSearch Service domain, configured for storing and querying image embeddings generated by [art-vandelay](https://www.github.com/reedmarkham/art-vandelay). It also deploys an S3 bucket for general usage (store image files, etc.).

It uses AWS Secrets Manager to securely manage OpenSearch credentials and provisions all necessary resources using infrastructure-as-code (AWS CDK).

## 📁 Folder Structure

```
art-vandelay-db/
├── bin/                           # CDK app entrypoint
│   └── art-vandelay-db.ts         # Main entrypoint for the CDK app
├── lib/                           # Main CDK stack definition
│   └── art-vandelay-db-stack.ts   # Provisions OpenSearch domain and resources
├── cdk.json                       # CDK project configuration
├── package.json                   # Node.js dependencies and scripts
├── README.md                      # Project documentation and usage
├── .github/
│   └── workflows/                 # GitHub Actions workflows for CI/CD
│       └── deploy.yml             # Workflow for deploying on commits to main
└── ...                            # Other standard CDK files/folders
```

## 🔐 Prerequisites

- **AWS IAM User:**  
  You need an AWS IAM user with an access key and secret key. This user should have a minimal policy similar to the following, granting permissions required for CDK to deploy OpenSearch, S3, and manage secrets:

  ```
  {
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Action": [
          "cloudformation:*",
          "iam:CreateRole",
          "iam:AttachRolePolicy",
          "iam:PassRole",
          "iam:DeleteRole",
          "iam:DetachRolePolicy",
          "s3:*",
          "secretsmanager:GetSecretValue",
          "secretsmanager:DescribeSecret",
          "logs:*",
          "events:*",
          "ec2:DescribeAvailabilityZones",
          "ec2:DescribeVpcs",
          "ec2:DescribeSubnets",
          "ec2:DescribeSecurityGroups",
          "ec2:DescribeRouteTables",
          "ec2:DescribeInternetGateways",
          "ssm:GetParameter",
          "ssm:GetParameters",
          "ssm:GetParametersByPath",
          "es:*"
        ],
        "Resource": "*"
      }
    ]
  }
  ```

- **Secrets Manager:**  
  A secret in AWS Secrets Manager named `art-vandelay-opensearch-main-user` will be created by the stack to store OpenSearch credentials for downstream usage.

- **GitHub Actions Repository Secrets:**  
  Before the GitHub Actions workflow can run, you need to add the following secrets to your repository:

  1. Go to your GitHub repository.
  2. Navigate to **Settings > Secrets and variables > Actions**.
  3. Add the following **repository secrets**:

  | Secret Name              | Description                                                    |
  |--------------------------|----------------------------------------------------------------|
  | `AWS_ACCESS_KEY_ID`      | AWS access key ID for the IAM user with permissions above      |
  | `AWS_SECRET_ACCESS_KEY`  | AWS secret access key for the IAM user                        |
  | `AWS_REGION`             | AWS region to deploy resources (e.g., `us-east-1`)            |

---

## 🚀 Deployment Instructions

This project uses GitHub Actions for CI/CD. On every commit to the `main` branch, the following steps are automatically performed:

1. Install dependencies.
2. Bootstrap the CDK environment (if needed).
3. Deploy the CDK stack to AWS.